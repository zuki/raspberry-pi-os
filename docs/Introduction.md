## Raspberry Pi OSプロジェクトの紹介、あるいは、オペレーティング・システムを効率よく学ぶ方法

数年前、私は初めてLinuxカーネルのソースコードを開きました。当時の私は
自分がソフトウェア開発者として多少なりともスキルがあると思っていました。
アセンブラやC言語を少しかじった程度でしたが、プロセススケジューリングや
仮想メモリ管理などのOSの主要な概念についてはよく理解していました。しかし、
私の最初の挑戦は完全に失敗でした。私は何も理解していなかったのです。

私がと解決しなければならないその他のソフトウェアプロジェクトでは、私は
シンプルなアプローチをとっていますが、たいていはうまくいきます。それは、
プログラムのエントリーポイントを見つけ、ソースコードを読み始め、興味を
持った細部をすべて理解するために必要なだけ深く掘り下げていく方法です。
この方法はうまくいくのですが、オペレーティングシステムのような高度な
ものには使えません。それは単にエントリーポイントを見つけるだけで1週間
以上もかかったというだけではなありません。一番の問題は、自分は数行の
コードを見ているだけであり、その行が何をしているかの手がかりを見つける
方法さえ見つけられないという状況にあることがすぐにわかったことでした。
これは特に低レベルのアセンブラソースコードで顕著でしたが、調べようと
したシステムの他の部分についても同じでした。

私はそれが複雑そうだからといって初めから問題を避けてしますのは好きでは
ありません。さらに、私は複雑な問題など存在しないと考えています。実際、
効率的に問題を解決する方法を単に私が知らない問題はたくさん存在します。
そこで私は、OSの開発全般、特にLinuxを効率的に学べる方法を探し始めました。

## OSの開発を学ぶ上での課題

Linuxカーネルの開発について書かれた本やドキュメントは山ほどありますが、
私が望むような学習効果が得られるものはありませんでした。これらの半分は
表面的なものですでに知っていることばかりです。残りの半分は、私がカーネル
ソースコードを調べていた時に感じた問題とよく似た問題があります。本の内容が
進むとすぐにその90%はセキュリティやパフォーマンス、レガシーに関する考察や
Linuxカーネルがサポートする何百万もの機能といった中心的な概念とは無関係と
思われるものに関係する内容です。その結果、オペレーティングシステムの中心と
なる概念を学ぶ代わりに、それらの機能の実装詳細を掘り下げることになって
しまうのです。

そもそも、なぜオペレーティングシステムの開発を学ぶ必要があるのかと思われるかも
しれません。私の場合は、背後で物事がどのように動いているのかに常に興味があったことが
主な理由です。単なる好奇心ではありません。取り組む課題が難しければ難しいほど
OSのレベルまでさかのぼって考えることが多くなるからです。下層レベルでの動作を
理解していないと、十分な情報に基づいた技術的な決定を下すことはできません。また、
技術的なチャレンジが好きな人にとっては、OS開発に取り組むことはエキサイティングな
課題になるでしょう。

次の疑問はなぜLinuxなのかでしょう。他のOSの方がとっつきやすいのではないか。
その答えは、自分の知識が、少なくとも何らかの形で、自分が現在行っている、あるいは
将来行うであろうことに関連していることを望んでいるからです。この点でLinuxは完璧です。
というのも、最近では小さなIoTデバイスから大規模なサーバーまであらゆるものが
Linuxで動く傾向にあるからです。

Linuxのカーネル開発に関する書籍のほとんどが私には合わないと言いましたが、それは
正確ではありませんでした。OS開発の初心者である私でも十分に理解できるように
実際のソースコードを使って本質的な概念を説明している本が一冊だけありました。
それは「Linuxデバイスドライバ」です。この本がLinuxカーネルに関する最も有名な
技術書の一冊であることも頷けます。この本は、まず、コンパイルして遊べる簡単な
ドライバのソースコードの紹介から始まります。そして、ドライバーに関する新しい
概念を一つずつ紹介し、その新しい概念を使うためにドライバーのソースコードを
どのように修正するかを説明しています。これこそが、私の言う「良い学習体験」
なのです。この本の唯一の問題点は、ドライバの開発に明確に焦点を当てており、
コアカーネルの実装の詳細についてはほとんど書かれていないことです。

では、なぜ誰もカーネル開発者向けに同じような本を作らなかったのでしょうか。
それは、本のベースとして現在のLinuxカーネルのソースコードを使おうとすると、
どうしても無理があるからだと思います。簡単な出発点として使えるような関数や
構造体、モジュールがLinuxには存在しましせん。Linuxのソースにはシンプルな
ものはないからです。また、新しい概念を一つずつ導入することもできません。
ソースコードの中ではすべてが互いに密接に関連しているからです。これに気づくと
私に一つのアイデアが浮かびました。それは、LinuxのカーネルがOS開発を学ぶための
出発点としてあまりにも膨大かつ複雑すぎるのであれば、学習用として明確に設計
された独自のOSを実装すればいいのではないかというものです。そうすれば、OSを
シンプルにして、より良い学習体験を与えることができます。また、このOSの実装の
ほとんどをLinuxカーネルソースのコピーとその単純化で行えば、Linuxカーネルを
学ぶための出発点としてもそのまま使えます。OSだけでなく、OS開発の主要な概念を
教え、OSのソースコードを完全に説明する一連のレクチャも書くことにしました。

## OSの要件

私は後に[RPi OS](https://github.com/s-matyukevich/raspberry-pi-os)となる
プロジェクトに着手しました。まず最初にしなければならなかったのは、カーネル開発の
どの部分が「基本」であり、どの部分がそれほど重要ではなく、（少なくとも最初の
うちは）省略してもよいかを決めることでした。私の理解では各オペレーティング
システムには2つの基本的な目標があります。

1. ユーザープロセスを隔離して実行する。
2. 各ユーザープロセスにハードウェアの統一されたビューを提供すること。

1つ目の要件を満たすために、RPi OSは独自のスケジューラを持つ必要があります。
スケジューラを実装するなら、タイマー割り込みも処理しなければなりません。
2つ目の要件は、OSが何らかのドライバをサポートし、それらをユーザアプリケーションに
公開するシステムコールを提供しなければならないことを意味します。このOSは初心者
向けなので、複雑なハードウェアは扱いたくありません。そこで、私が関心を持つドライバは
画面に何かを書き込み、キーボードからユーザの入力を読み込むことができるドライバ
だけです。また、OSはユーザプログラムを読み込んで実行できる必要があるので、当然、
何らかのファイルシステムをサポートし、何らかの実行ファイル形式を理解できる必要が
あります。OSが基本的なネットワークをサポートしていればいいのですが、初心者向けの
テキストではそのようなことは重視したくありません。以上が私が基本的に「あらゆるOSの
中心的概念」として認識できるものです。

では、無視したいものを見てみましょう。

1. **パフォーマンス** 高度なアルゴリズムをOSには使いたくありません。また、シンプルにするために、キャッシュなどのパフォーマンス最適化技術はすべて無効にするつもりです。
2. **セキュリティ** RPi OSには少なくとも仮想メモリというセキュリティ機能があるのは事実です。それ以外はすべて安全に無視することができます。
3. **マルチプロセッシングと同期** 私は自分のOSがシングルプロセッサコアで実行されることに満足しています。特に、同期という膨大な複雑さの原因を取り除くことができるからです。
4. **複数のアーキテクチャと様々なデバイスのサポート** これについては次節で説明します。
5. **製品版のOSがサポートするその他無数の機能**

## どうしてラズベリーパイなのか

RPi OSが複数のコンピュータアーキテクチャや数多くの様々なデバイスをサポートする
ことを私が望んでいないことはすでに述べました。Linuxカーネルのドライバモデルを
調べてみて、その思いはさらに強くなりました。同じような目的を持ったデバイスでも
その実装内容は大きく異なるようです。そのため、ドライバの種類に応じたシンプルな
抽象化やドライバのソースコードの再利用は非常に難しくなります。私にはこれが
Linuxカーネルを複雑にしている原因のひとつだと思えるので、RPi OSでは絶対に避けたいと
思っています。では、どんなコンピュータを使うべきなのか。ベアメタルプログラムの
テストのために現座使っているラップトップを使いたくないのは明らかです。さらに
重要なことは、私のOS開発の課題を行うために高価なノートパソコンを買ってもらいたくは
ありません（どうせ誰もやらないだろうけど）。エミュレータを使うのもいいかも
しれませんが、私は本物のデバイスを使いたいと思っています。そのほうが、ベアメタル
プログラミングで遊んでいるというよりも、何か現実的なことをやっているという感じが
するからです。

私は結局、Raspberry Pi、特に、[Raspberry Pi 3 Model B](https://www.raspberrypi.org/products/raspberry-pi-3-model-b/)を使うことにしました。このデバイスを使うことは
多くの理由により理想的な選択だと思われます。

1. 価格が35ドル前後。これは手ごろな価格だと思います。
2. 学習用に特別に設計されている。内部のアーキテクチャが可能な限りシンプルであり、
   私のニーズにぴったり合っています。
3. ARM v8アーキテクチャを採用している。このデバイスは。シンプルなRISCアーキテクチャで
   あり、OS製作者のニーズによく対応しており、たとえば人気の高いx86アーキテクチャの
   ように多くのレガシー要件がありません。私を信じられない方は、Linuxカーネルの
   `/arch/arm64`フォルダと`/arch/x86`フォルダにあるソースコードの量を比較してみて
   ください。

このOSはRaspberry Piの旧バージョンでは使用できません。なぜなら、それらは64ビット
ARM v8アーキテクチャをサポートしていないからです。今度出るであろうすべてのデバイスの
サポートは簡単だと思います。

## コミュニティとの連携

技術書の大きな欠点は、発売後すぐに陳腐化してしまうことです。最近の技術は非常に速く
進化しているので、本を書く人がそれに追いつくのはほとんど不可能です。だからこそ、
私は、インターネット上で自由に利用でき、読者がコンテンツの作成や検証に参加できる
本である「オープンソースブック」というアイデアが好きなのです。本の内容がGithubで
公開されていれば、読者は誰でも簡単に新しいコードサンプルを修正・開発したり、本の
内容を更新したり、新しい章の執筆に参加することができます。このプロジェクトが現時点では
完璧ではないことは理解していますし、この記事を書いている時点ではまだ完成していません。
それでも私は今この本を出版したいと思っています。コミュニティの助けを借りれば、
このプロジェクトをより早く完成させることができるだけでなく、当初よりもはるかに
優れた、より便利なものにすることができると期待するからです。

##### 前ページ

[Main Page](../README.md)

##### 次ページ

[Contributing to the Raspberry PI OS](../docs/Contributions.md)
